{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
  <!-- Status Card with Gradient -->
  <div class="bg-gradient-to-r from-blue-500 to-indigo-600 dark:from-blue-700 dark:to-indigo-800 rounded-xl shadow-lg p-8 text-white">
    <div class="flex items-center justify-between">
      <div class="flex-1">
        <h2 class="text-sm font-semibold text-blue-100 mb-2">
          <i class="fas fa-circle-notch mr-2"></i> <span data-i18n="service_status">Service Status</span>
        </h2>
        <p class="text-4xl font-bold flex items-center gap-3">
          <span id="service-status" class="{% if status.running %}text-green-300{% else %}text-red-300{% endif %}">
            {% if status.running %}
              <i class="fas fa-check-circle"></i> <span data-i18n="running">Running</span>
            {% else %}
              <i class="fas fa-times-circle"></i> <span data-i18n="stopped">Stopped</span>
            {% endif %}
          </span>
        </p>
        {% if status.pid %}<p class="text-blue-100 mt-2">PID: <span class="font-mono">{{ status.pid }}</span></p>{% endif %}
        <p class="text-blue-100 mt-1">Instance: <span id="instance-id" class="font-mono">{{ status.instance_id or 'n/a' }}</span></p>
      </div>
      <div class="flex flex-col items-center gap-4">
        <div class="text-6xl opacity-20">
          <i class="fas fa-server"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Control Buttons - 3 Column Grid -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Start Button -->
    <button
      onclick="executeAction('start')"
      class="bg-green-500 hover:bg-green-600 dark:bg-green-700 dark:hover:bg-green-800 text-white font-bold py-6 px-8 rounded-xl shadow-lg transition transform hover:scale-105 active:scale-95 flex flex-col items-center gap-4"
    >
      <i class="fas fa-play text-4xl"></i>
      <span class="text-lg" data-i18n="start">Start</span>
      <span class="text-xs opacity-75" data-i18n="service_label">Service</span>
    </button>

    <!-- Stop Button with in-button Arrow Dropdown -->
    <button
      onclick="executeAction('stop')"
      class="relative bg-red-500 hover:bg-red-600 dark:bg-red-700 dark:hover:bg-red-800 text-white font-bold py-6 px-8 rounded-xl shadow-lg transition transform hover:scale-105 active:scale-95 flex flex-col items-center gap-4"
    >
      <i class="fas fa-stop text-4xl"></i>
      <span class="text-lg" data-i18n="stop">Stop</span>
      <span class="text-xs opacity-75" data-i18n="service_label">Service</span>

      <!-- Arrow-only trigger INSIDE the button (top-right corner) -->
      <span class="absolute top-2 right-2 group" onclick="event.stopPropagation();">
        <span
          title="Menu de ações do serviço"
          data-i18n-title="service_menu_tooltip"
          class="text-white/80 hover:text-white p-1"
        >
          <i class="fas fa-chevron-down"></i>
        </span>
        <!-- Dropdown Panel -->
        <span class="absolute right-0 mt-1 w-56 bg-white dark:bg-gray-800 rounded-lg shadow-xl hidden group-hover:block py-2 z-50">
          <span 
            role="button"
            tabindex="0"
            onclick="confirmScanAndKill(); event.stopPropagation();" 
            class="block w-full text-left px-4 py-3 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm transition"
          >
            <i class="fas fa-sync-alt text-blue-500 mr-2"></i>
            <span data-i18n="scan_kill_btn">Clear orphan processes</span>
            <span class="block text-xs text-gray-500 dark:text-gray-400 mt-1" data-i18n="scan_kill_desc">Terminate all running service processes</span>
          </span>
          <span 
            role="button"
            tabindex="0"
            onclick="confirmScanAndKillOthers(); event.stopPropagation();" 
            class="block w-full text-left px-4 py-3 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm transition"
          >
            <i class="fas fa-broom text-purple-500 mr-2"></i>
            <span>Limpar outras instâncias</span>
            <span class="block text-xs text-gray-500 dark:text-gray-400 mt-1">Encerra processos de outras cópias/instâncias</span>
          </span>
        </span>
      </span>
    </button>

    <!-- Restart Button -->
    <button 
      onclick="executeAction('restart')" 
      class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-700 dark:hover:bg-blue-800 text-white font-bold py-6 px-8 rounded-xl shadow-lg transition transform hover:scale-105 active:scale-95 flex flex-col items-center gap-4"
    >
      <i class="fas fa-sync text-4xl"></i>
      <span class="text-lg" data-i18n="restart">Restart</span>
      <span class="text-xs opacity-75" data-i18n="service_label">Service</span>
    </button>
  </div>

  <!-- Recent Logs Card -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
    <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
      <i class="fas fa-history text-blue-500"></i>
      <span data-i18n="recent_logs">Recent Logs</span>
    </h3>
    <div id="logs-container" class="space-y-3 max-h-96 overflow-y-auto">
      <div class="text-center py-8">
        <i class="fas fa-spinner text-2xl text-blue-500 animate-spin mb-2"></i>
        <p class="text-gray-500 dark:text-gray-400">Loading logs...</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Load logs asynchronously after page loads
  async function loadLogsAsync() {
    try {
      const response = await fetch('/api/logs?limit=10');
      const data = await response.json();
      const container = document.getElementById('logs-container');
      
      if (!data.logs || data.logs.length === 0) {
        container.innerHTML = `
          <p class="text-gray-500 dark:text-gray-400 text-center py-8">
            <i class="fas fa-inbox text-2xl mb-2 block"></i>
            <span>${t('no_logs')}</span>
          </p>
        `;
        return;
      }
      
      let html = '';
      for (const log of data.logs) {
        html += `
          <a 
            href="/logs/view?path=${encodeURIComponent(log.path)}" 
            class="block p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-blue-50 dark:hover:bg-gray-600 transition border-l-4 border-blue-500"
          >
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <i class="fas fa-file-alt text-gray-500"></i>
                <div>
                  <p class="font-semibold">${log.name}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">${log.size} bytes</p>
                </div>
              </div>
              <i class="fas fa-chevron-right text-gray-400"></i>
            </div>
          </a>
        `;
      }
      container.innerHTML = html;
    } catch (err) {
      const container = document.getElementById('logs-container');
      container.innerHTML = `
        <p class="text-red-500 text-center py-8">
          <i class="fas fa-exclamation-triangle text-2xl mb-2 block"></i>
          Error loading logs
        </p>
      `;
    }
  }

  // Load logs after page is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadLogsAsync);
  } else {
    loadLogsAsync();
  }

  let lastSvcRunning = null;
  let lastSvcPid = null;
  let lastStopNotifiedPid = null;

  // Auto-update status every 2 seconds
  function updateStatus() {
    fetch('/status')
      .then(response => response.json())
      .then(data => {
        const statusElement = document.getElementById('service-status');
        const iidEl = document.getElementById('instance-id');
        const running = !!data.running;
        const pid = data.pid;
        const logPath = (data.service && data.service.log) || data.log;

        if (statusElement) {
          const icon = running ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>';
          const labelKey = running ? 'running' : 'stopped';
          statusElement.className = running ? 'text-green-300' : 'text-red-300';
          statusElement.innerHTML = `${icon} <span>${t(labelKey)}</span>`;
        }

        if (iidEl) {
          iidEl.textContent = data.instance_id || 'n/a';
        }

        // Detect unexpected stop only during start/restart transition
        if ((window.serviceTransition === 'start' || window.serviceTransition === 'restart') && lastSvcRunning === true && !running && lastSvcPid && lastStopNotifiedPid !== lastSvcPid) {
          const msg = `${t('service_stop_failed')}: PID ${lastSvcPid}. ${logPath ? 'Log: ' + logPath : ''}`;
          showNotification(msg, 'error', 8000);
          lastStopNotifiedPid = lastSvcPid;
          // Clear transition marker to avoid repeated notifications
          window.serviceTransition = null;
        }

        lastSvcRunning = running;
        lastSvcPid = pid || lastSvcPid;
      })
      .catch(err => console.error('Status update error:', err));
  }

  // Update status every 2 seconds
  setInterval(updateStatus, 2000);
</script>
{% endblock %}
