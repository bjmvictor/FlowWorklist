<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FlowWorklist</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='brand/logo-mark.png') }}">
    <link rel="alternate icon" type="image/png" href="{{ url_for('static', filename='brand/logo-mark.svg') }}">
    <meta name="theme-color" content="#1e3a8a">
    <script>
      // Configure Tailwind dark mode to use the 'class' strategy (light theme by default)
      tailwind = window.tailwind || {};
      tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
      .notification { position: fixed; right: 20px; z-index: 1000; max-width: 400px; transition: top 0.3s ease-out; }
      @keyframes slideIn { from { transform: translateX(450px); } to { transform: translateX(0); } }
      .notification-enter { animation: slideIn 0.3s ease-out; }
      @keyframes slideOut { from { transform: translateX(0); } to { transform: translateX(450px); } }
      .notification-exit { animation: slideOut 0.3s ease-out; }

      
      /* Unread notification badge */
      .notification-badge { 
        position: absolute; 
        top: -5px; 
        right: -5px; 
        background: #ef4444; 
        color: white; 
        border-radius: 50%; 
        width: 22px; 
        height: 22px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 12px; 
        font-weight: bold;
      }
      
      /* Notification dropdown styles */
      .notification-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        width: 380px;
        max-height: 500px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        margin-top: 8px;
        display: none;
        overflow-x: hidden;
      }
      
      .dark .notification-dropdown {
        background: #1f2937;
      }
      
      .notification-dropdown.show {
        display: block;
      }
      
      .notification-item {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        transition: background-color 0.2s;
        color: #111827;
      }
      
      .dark .notification-item {
        color: #f3f4f6;
      }
      
      .notification-item:hover {
        background-color: #e5e7eb;
      }
      
      .dark .notification-item:hover {
        background-color: #4b5563;
      }
      
      .notification-item.unread {
        background-color: #dbeafe;
      }
      
      .dark .notification-item.unread {
        background-color: #1e40af;
      }
      
      .notification-item-time {
        font-size: 12px;
        color: #9ca3af;
      }
    </style>
    <script>
      // Complete translation system with multiple languages
      const translations = {
        pt: {
          'home': 'Início', 'config': 'Configuração', 'logs': 'Logs', 'tests': 'Testes', 'plugins': 'Plugins',
          'start': 'Iniciar', 'stop': 'Parar', 'restart': 'Reiniciar', 'recent_logs': 'Logs Recentes', 'back': 'Voltar',
          'save': 'Salvar', 'clear': 'Limpar', 'clear_logs': 'Limpar Logs', 'no_logs': 'Nenhum log encontrado', 'language': 'Idioma',
          'theme': 'Tema', 'status': 'Status', 'service_status': 'Status do Serviço', 'service_label': 'Serviço',
          'service_starting': 'Serviço iniciando...', 'service_started': 'Serviço iniciado com sucesso', 'service_start_failed': 'Falha ao iniciar serviço',
          'service_stopping': 'Serviço parando...', 'service_stopped': 'Serviço parado com sucesso', 'service_stop_failed': 'Falha ao parar serviço',
          'service_restarting': 'Serviço reiniciando...', 'service_restarted': 'Serviço reiniciado com sucesso', 'service_restart_failed': 'Falha ao reiniciar serviço',
          'service_hint_active': 'Serviço ativo', 'service_hint_stopped': 'Serviço parado', 'service_hint_unavailable': 'Serviço indisponível',
          'test_dcm_echo': 'Teste DICOM C-ECHO', 'test_dcm_find': 'Teste DICOM C-FIND', 'test_dcm_worklist': 'Teste de Resposta da Worklist',
          'desc_echo': 'Teste a associação DICOM e a resposta do servidor.', 'desc_find': 'Pesquise itens da worklist no banco de dados.', 'desc_worklist': 'Teste resposta DICOM C-FIND worklist com dados de pacientes reais.',
          'desc_db_conn': 'Teste a conectividade do banco de dados', 'desc_status': 'Verifique se o serviço está acessível e respondendo.',
          'check_availability': 'Verificar Disponibilidade', 'test_connection': 'Testar Conexão', 'test_worklist': 'Resposta da Worklist', 'install_db_driver': 'Instalar Plugin de Banco', 'install_pynetdicom': 'Instalar Plugin pynetdicom', 'install_pynetdicom': 'Instalar Plugin pynetdicom',
          'running_test': 'Executando teste...', 'test_passed': 'Teste passou', 'test_failed': 'Teste falhou', 'output': 'Saída', 'copy': 'Copiar',
          'running': 'Em execução', 'stopped': 'Parado', 'notifications': 'Notificações', 'no_notifications': 'Nenhuma notificação',
          'server_settings': 'CONFIGURAÇÕES DO SERVIDOR', 'aet_title': 'AE Title', 'aet_title_full': 'Título DICOM Application Entity',
          'listen_all_interfaces': 'Escutar em todas as interfaces', 'host': 'Host/IP', 'port': 'Porta', 'server_port_full': 'Porta do servidor DICOM',
          'client_aet': 'Client AE', 'client_aet_title_full': 'Título AE do cliente esperado', 'database_settings': 'CONFIGURAÇÕES DO BANCO DE DADOS',
          'database_type': 'Tipo', 'database_dsn': 'DSN', 'dsn_hint': 'Formato: IP:PORTA/DB (ex.: 192.168.1.3:1521/PRD)',
          'database_user': 'Usuário', 'database_password': 'Senha', 'database_query': 'Query', 'sql_hint': 'Consulta SQL que retorna os itens da Worklist',
          'sql_guide_title': 'Guia de colunas esperadas pela Worklist', 'sql_guide_warning': '⚠️ Query deve retornar EXATAMENTE 17 colunas nesta ordem:',
          'sql_guide_link': 'Ver guia completo com exemplos SQL',
          'sql_col1_hint': '(Nome completo do paciente)', 'sql_col2_hint': '(Identificador único)',
          'sql_col5_hint': '(Descrição do exame)', 'sql_col6_hint': '(Número do pedido)',
          'sql_col9_hint': '(Nome completo do médico)', 'sql_col12_hint': '(Tipo de atendimento)',
          'sql_col13_hint': '(ID do atendimento)', 'sql_col14_hint': '(Local do exame)',
          'sql_col15_hint': '(Código do procedimento)', 'sql_col16_hint': '(Significado do código)',
          'sql_col17_hint': '(Esquema de codificação)',
          'error_missing_module': 'Erro: Módulo não encontrado',
          'test_database': 'Teste de Banco de Dados', 'test_status': 'Teste de Status', 'test_console': 'Console de Testes',
          'plugins_desc': 'Instale ou remova plugins opcionais que estendem funcionalidades (ex.: drivers de banco). Tipo de banco atual:',
          'module': 'Módulo', 'package': 'Pacote', 'install': 'Instalar', 'uninstall': 'Desinstalar',
          'installed': 'Instalado', 'not_installed': 'Não instalado', 'current': 'atual', 'console_ready': '$ Pronto para testes...',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'config_saved': 'Configurações salvas com sucesso!',
          'config_save_error': 'Erro ao salvar configurações',
          'scan_kill_btn': 'Limpar processos órfãos', 'scan_kill_desc': 'Encerra todos os processos do serviço em execução',
          'scan_kill_tooltip': 'Menu de serviço', 'service_menu_tooltip': 'Menu de ações do serviço',
          'scan_kill_confirm_title': 'Confirmar Limpeza de Processos',
          'scan_kill_confirm_msg': 'Isto irá encerrar todos os processos do serviço DICOM em execução. Deseja continuar?',
          'scan_kill_scanning': 'Verificando processos em execução...', 'scan_kill_none': 'Nenhum processo de serviço encontrado.',
          'scan_kill_killed': 'Eliminados {count} processo(s): {pids}', 'scan_kill_error': 'Erro ao limpar processos: {error}',
          'config_error': 'Erro de Configuração', 'config_missing': 'Arquivo config.json não encontrado',
          'config_invalid': 'Configuração inválida ou incompleta', 'config_check_msg': 'Por favor, verifique suas configurações em config.json',
          'config_json_invalid': 'JSON inválido em config.json',
          'config_view': 'Ver Configuração',
          'test_success': 'SUCESSO', 'test_failed': 'FALHA', 'test_error': 'ERRO',
          'install_pynetdicom_plugin': 'Instalar Plugin pynetdicom',
          'title_notifications': 'Notificações', 'title_clear_history': 'Limpar histórico', 'title_install_db_driver': 'Instalar driver de banco baseado em config.json',
          'clear_logs_confirm': 'Limpar todos os arquivos de log?',
          'uninstall_confirm': 'Tem certeza que deseja desinstalar este plugin?',
        },
        en: {
          'home': 'Home', 'config': 'Config', 'logs': 'Logs', 'tests': 'Tests', 'plugins': 'Plugins',
          'start': 'Start', 'stop': 'Stop', 'restart': 'Restart', 'recent_logs': 'Recent Logs', 'back': 'Back',
          'save': 'Save', 'clear': 'Clear', 'clear_logs': 'Clear Logs', 'no_logs': 'No logs found', 'language': 'Language',
          'theme': 'Theme', 'status': 'Status', 'service_status': 'Service Status', 'service_label': 'Service',
          'service_starting': 'Service starting...', 'service_started': 'Service started successfully', 'service_start_failed': 'Failed to start service',
          'service_stopping': 'Service stopping...', 'service_stopped': 'Service stopped successfully', 'service_stop_failed': 'Failed to stop service',
          'service_restarting': 'Service restarting...', 'service_restarted': 'Service restarted successfully', 'service_restart_failed': 'Failed to restart service',
          'service_hint_active': 'Service running', 'service_hint_stopped': 'Service stopped', 'service_hint_unavailable': 'Service unavailable',
          'test_dcm_echo': 'DICOM C-ECHO Test', 'test_dcm_find': 'DICOM C-FIND Test', 'test_dcm_worklist': 'Worklist Response Test',
          'desc_echo': 'Test the DICOM association and echo response from the server.', 'desc_find': 'Search for worklist items in the DICOM database.', 'desc_worklist': 'Test DICOM C-FIND worklist response with actual patient data.',
          'desc_db_conn': 'Test database connectivity', 'desc_status': 'Check if the service is accessible and responding.',
          'check_availability': 'Check Availability', 'test_connection': 'Test Connection', 'test_worklist': 'Worklist Response', 'install_db_driver': 'Install DB Driver', 'install_pynetdicom': 'Install pynetdicom Plugin', 'install_pynetdicom': 'Install pynetdicom Plugin',
          'running_test': 'Running test...', 'test_passed': 'Test passed', 'test_failed': 'Test failed', 'output': 'Output', 'copy': 'Copy',
          'running': 'Running', 'stopped': 'Stopped', 'notifications': 'Notifications', 'no_notifications': 'No notifications',
          'server_settings': 'SERVER SETTINGS', 'aet_title': 'AE Title', 'aet_title_full': 'DICOM Application Entity Title',
          'listen_all_interfaces': 'Listen on all interfaces', 'host': 'Host/IP', 'port': 'Port', 'server_port_full': 'DICOM server port',
          'client_aet': 'Client AE', 'client_aet_title_full': 'Expected client AE Title', 'database_settings': 'DATABASE SETTINGS',
          'database_type': 'Type', 'database_dsn': 'DSN', 'dsn_hint': 'Format: IP:PORT/DB (e.g.: 192.168.1.3:1521/PRD)',
          'database_user': 'User', 'database_password': 'Password', 'database_query': 'Query', 'sql_hint': 'SQL query that returns Worklist items',
          'sql_guide_title': 'Guide to expected Worklist columns', 'sql_guide_warning': '⚠️ Query must return EXACTLY 17 columns in this order:',
          'sql_guide_link': 'View complete guide with SQL examples',
          'sql_col1_hint': '(Full patient name)', 'sql_col2_hint': '(Unique identifier)',
          'sql_col5_hint': '(Exam description)', 'sql_col6_hint': '(Request number)',
          'sql_col9_hint': '(Full physician name)', 'sql_col12_hint': '(Encounter type)',
          'sql_col13_hint': '(Encounter ID)', 'sql_col14_hint': '(Exam location)',
          'sql_col15_hint': '(Procedure code)', 'sql_col16_hint': '(Code meaning)',
          'sql_col17_hint': '(Coding scheme)',
          'error_missing_module': 'Error: Module not found',
          'test_database': 'Database Test', 'test_status': 'Status Test', 'test_console': 'Test Console',
          'plugins_desc': 'Install or remove optional plugins that extend functionality (e.g., database drivers). Current DB type:',
          'module': 'Module', 'package': 'Package', 'install': 'Install', 'uninstall': 'Uninstall',
          'installed': 'Installed', 'not_installed': 'Not installed', 'current': 'current', 'console_ready': '$ Ready for tests...',
          'test_success': 'SUCCESS', 'test_failed': 'FAILED', 'test_error': 'ERROR',
          'install_pynetdicom_plugin': 'Install pynetdicom Plugin',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'title_notifications': 'Notifications', 'title_clear_history': 'Clear history', 'title_install_db_driver': 'Install DB driver based on config.json',
          'config_saved': 'Configuration saved successfully!',
          'config_save_error': 'Error saving configuration',
          'scan_kill_btn': 'Clear orphan processes', 'scan_kill_desc': 'Terminate all running service processes',
          'scan_kill_tooltip': 'Service menu', 'service_menu_tooltip': 'Service action menu',
          'scan_kill_confirm_title': 'Confirm Process Cleanup',
          'scan_kill_confirm_msg': 'This will terminate all running DICOM service processes. Do you want to continue?',
          'scan_kill_scanning': 'Scanning for running processes...', 'scan_kill_none': 'No running service processes found.',
          'scan_kill_killed': 'Killed {count} process(es): {pids}', 'scan_kill_error': 'Error clearing processes: {error}',
          'config_error': 'Configuration Error', 'config_missing': 'config.json file not found',
          'config_invalid': 'Invalid or incomplete configuration', 'config_check_msg': 'Please check your configuration in config.json',
          'config_json_invalid': 'Invalid JSON in config.json',
          'config_view': 'View Configuration',
          'clear_logs_confirm': 'Clear all log files?',
          'uninstall_confirm': 'Are you sure you want to uninstall this plugin?'
        },
        es: {
          'home': 'Inicio', 'config': 'Configuración', 'logs': 'Registros', 'tests': 'Pruebas', 'plugins': 'Complementos',
          'start': 'Iniciar', 'stop': 'Detener', 'restart': 'Reiniciar', 'recent_logs': 'Registros Recientes', 'back': 'Atrás',
          'save': 'Guardar', 'clear': 'Borrar', 'clear_logs': 'Borrar Registros', 'no_logs': 'No se encontraron registros', 'language': 'Idioma',
          'theme': 'Tema', 'status': 'Estado', 'service_status': 'Estado del Servicio', 'service_label': 'Servicio',
          'service_starting': 'Iniciando servicio...', 'service_started': 'Servicio iniciado correctamente', 'service_start_failed': 'Error al iniciar el servicio',
          'service_stopping': 'Deteniendo servicio...', 'service_stopped': 'Servicio detenido correctamente', 'service_stop_failed': 'Error al detener el servicio',
          'service_restarting': 'Reiniciando servicio...', 'service_restarted': 'Servicio reiniciado correctamente', 'service_restart_failed': 'Error al reiniciar el servicio',
          'service_hint_active': 'Servicio activo', 'service_hint_stopped': 'Servicio detenido', 'service_hint_unavailable': 'Servicio no disponible',
          'test_dcm_echo': 'Prueba DICOM C-ECHO', 'test_dcm_find': 'Prueba DICOM C-FIND', 'test_dcm_worklist': 'Prueba de Respuesta de Worklist',
          'desc_echo': 'Prueba la asociación DICOM y la respuesta de echo del servidor.', 'desc_find': 'Busca elementos de la lista de trabajo en la base de datos DICOM.', 'desc_worklist': 'Prueba la respuesta DICOM C-FIND worklist con datos de pacientes reales.',
          'desc_db_conn': 'Prueba la conectividad de la base de datos', 'desc_status': 'Verifica si el servicio es accesible y responde.',
          'check_availability': 'Verificar Disponibilidad', 'test_connection': 'Probar Conexión', 'test_worklist': 'Respuesta de Worklist', 'install_db_driver': 'Instalar Controlador de BD', 'install_pynetdicom': 'Instalar Complemento pynetdicom',
          'running_test': 'Ejecutando prueba...', 'test_passed': 'Prueba completada', 'test_failed': 'Prueba fallida', 'output': 'Salida', 'copy': 'Copiar',
          'running': 'Ejecutándose', 'stopped': 'Detenido', 'notifications': 'Notificaciones', 'no_notifications': 'Sin notificaciones',
          'server_settings': 'CONFIGURACIÓN DEL SERVIDOR', 'aet_title': 'Título AE', 'aet_title_full': 'Título de Entidad de Aplicación DICOM',
          'listen_all_interfaces': 'Escuchar en todas las interfaces', 'host': 'Host/IP', 'port': 'Puerto', 'server_port_full': 'Puerto del servidor DICOM',
          'client_aet': 'AE de Cliente', 'client_aet_title_full': 'Título AE del cliente esperado', 'database_settings': 'CONFIGURACIÓN DE BASE DE DATOS',
          'database_type': 'Tipo', 'database_dsn': 'DSN', 'dsn_hint': 'Formato: IP:PUERTO/BD (ej: 192.168.1.3:1521/PRD)',
          'database_user': 'Usuario', 'database_password': 'Contraseña', 'database_query': 'Consulta', 'sql_hint': 'Consulta SQL que devuelve elementos de Worklist',
          'sql_guide_title': 'Guía de columnas esperadas por Worklist', 'sql_guide_warning': '⚠️ La consulta debe devolver EXACTAMENTE 17 columnas en este orden:',
          'sql_guide_link': 'Ver guía completa con ejemplos SQL',
          'sql_col1_hint': '(Nombre completo del paciente)', 'sql_col2_hint': '(Identificador único)',
          'sql_col5_hint': '(Descripción del examen)', 'sql_col6_hint': '(Número de solicitud)',
          'sql_col9_hint': '(Nombre completo del médico)', 'sql_col12_hint': '(Tipo de consulta)',
          'sql_col13_hint': '(ID de consulta)', 'sql_col14_hint': '(Lugar del examen)',
          'sql_col15_hint': '(Código de procedimiento)', 'sql_col16_hint': '(Significado del código)',
          'sql_col17_hint': '(Esquema de codificación)',
          'error_missing_module': 'Error: Módulo no encontrado',
          'test_database': 'Prueba de Base de Datos', 'test_status': 'Prueba de Estado', 'test_console': 'Consola de Pruebas',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'plugins_desc': 'Instala o desinstala complementos opcionales que amplían la funcionalidad (ej: controladores de BD). Tipo de BD actual:',
          'module': 'Módulo', 'package': 'Paquete', 'install': 'Instalar', 'uninstall': 'Desinstalar',
          'installed': 'Instalado', 'not_installed': 'No instalado', 'current': 'actual', 'console_ready': '$ Listo para pruebas...',
          'test_success': 'ÉXITO', 'test_failed': 'FALLIDA', 'test_error': 'ERROR',
          'config_saved': '¡Configuración guardada correctamente!',
          'config_save_error': 'Error al guardar la configuración',
          'scan_kill_btn': 'Limpiar procesos huérfanos', 'scan_kill_desc': 'Terminar todos los procesos de servicio en ejecución',
          'scan_kill_tooltip': 'Menú de servicio', 'service_menu_tooltip': 'Menú de acciones del servicio',
          'scan_kill_confirm_title': 'Confirmar Limpieza de Procesos',
          'scan_kill_confirm_msg': 'Esto terminará todos los procesos de servicio DICOM en ejecución. ¿Deseas continuar?',
          'scan_kill_scanning': 'Escaneando procesos en ejecución...', 'scan_kill_none': 'No se encontraron procesos de servicio en ejecución.',
          'scan_kill_killed': 'Se terminaron {count} proceso(s): {pids}', 'scan_kill_error': 'Error al limpiar procesos: {error}',
          'config_error': 'Error de Configuración', 'config_missing': 'Archivo config.json no encontrado',
          'config_invalid': 'Configuración inválida o incompleta', 'config_check_msg': 'Por favor, verifica tu configuración en config.json',
          'config_json_invalid': 'JSON inválido en config.json',
          'config_view': 'Ver Configuración',
          'test_success': 'ÉXITO', 'test_failed': 'FALLIDA', 'test_error': 'ERROR',
          'install_pynetdicom_plugin': 'Instalar Complemento pynetdicom',
          'title_notifications': 'Notificaciones', 'title_clear_history': 'Limpiar historial', 'title_install_db_driver': 'Instalar controlador de BD basado en config.json',
          'clear_logs_confirm': '¿Limpiar todos los archivos de registro?',
          'uninstall_confirm': '¿Estás seguro de que deseas desinstalar este complemento?',
        },
        fr: {
          'home': 'Accueil', 'config': 'Configuration', 'logs': 'Journaux', 'tests': 'Tests', 'plugins': 'Plugins',
          'start': 'Démarrer', 'stop': 'Arrêter', 'restart': 'Redémarrer', 'recent_logs': 'Journaux Récents', 'back': 'Retour',
          'save': 'Enregistrer', 'clear': 'Effacer', 'clear_logs': 'Effacer les journaux', 'no_logs': 'Aucun journal trouvé', 'language': 'Langue',
          'theme': 'Thème', 'status': 'Statut', 'service_status': 'Statut du Service', 'service_label': 'Service',
          'service_starting': 'Service en cours de démarrage...', 'service_started': 'Service démarré avec succès', 'service_start_failed': 'Échec du démarrage du service',
          'service_stopping': 'Service en cours d\'arrêt...', 'service_stopped': 'Service arrêté avec succès', 'service_stop_failed': 'Échec de l\'arrêt du service',
          'service_restarting': 'Service en cours de redémarrage...', 'service_restarted': 'Service redémarré avec succès', 'service_restart_failed': 'Échec du redémarrage du service',
          'service_hint_active': 'Service actif', 'service_hint_stopped': 'Service arrêté', 'service_hint_unavailable': 'Service indisponible',
          'test_dcm_echo': 'Test DICOM C-ECHO', 'test_dcm_find': 'Test DICOM C-FIND', 'test_dcm_worklist': 'Test de réponse Worklist',
          'desc_echo': 'Testez l\'association DICOM et la réponse d\'écho du serveur.', 'desc_find': 'Recherchez des éléments de la liste de travail dans la base de données DICOM.', 'desc_worklist': 'Testez la réponse DICOM C-FIND worklist avec les données réelles des patients.',
          'desc_db_conn': 'Testez la connectivité de la base de données', 'desc_status': 'Vérifiez si le service est accessible et répond.',
          'check_availability': 'Vérifier la disponibilité', 'test_connection': 'Tester la connexion', 'test_worklist': 'Réponse Worklist', 'install_db_driver': 'Installer le plugin de base de données', 'install_pynetdicom': 'Installer le plugin pynetdicom',
          'running_test': 'Test en cours d\'exécution...', 'test_passed': 'Test réussi', 'test_failed': 'Échec du test', 'output': 'Sortie', 'copy': 'Copier',
          'running': 'En cours d\'exécution', 'stopped': 'Arrêté', 'notifications': 'Notifications', 'no_notifications': 'Aucune notification',
          'server_settings': 'PARAMÈTRES DU SERVEUR', 'aet_title': 'Titre AE', 'aet_title_full': 'Titre DICOM Application Entity',
          'listen_all_interfaces': 'Écouter sur toutes les interfaces', 'host': 'Hôte/IP', 'port': 'Port', 'server_port_full': 'Port du serveur DICOM',
          'client_aet': 'AE Client', 'client_aet_title_full': 'Titre AE du client attendu', 'database_settings': 'PARAMÈTRES DE LA BASE DE DONNÉES',
          'database_type': 'Type', 'database_dsn': 'DSN', 'dsn_hint': 'Format: IP:PORT/DB (ex.: 192.168.1.3:1521/PRD)',
          'database_user': 'Utilisateur', 'database_password': 'Mot de passe', 'database_query': 'Requête', 'sql_hint': 'Requête SQL qui retourne les éléments de Worklist',
          'sql_guide_title': 'Guide des colonnes attendues par la liste de travail', 'sql_guide_warning': '⚠️ La requête doit retourner EXACTEMENT 17 colonnes dans cet ordre:',
          'sql_guide_link': 'Voir le guide complet avec des exemples SQL',
          'sql_col1_hint': '(Nom complet du patient)', 'sql_col2_hint': '(Identifiant unique)',
          'sql_col5_hint': '(Description de l\'examen)', 'sql_col6_hint': '(Numéro de demande)',
          'sql_col9_hint': '(Nom complet du médecin)', 'sql_col12_hint': '(Type de consultation)',
          'sql_col13_hint': '(ID de consultation)', 'sql_col14_hint': '(Lieu de l\'examen)',
          'sql_col15_hint': '(Code de procédure)', 'sql_col16_hint': '(Signification du code)',
          'sql_col17_hint': '(Schéma de codage)',
          'error_missing_module': 'Erreur: Module introuvable',
          'test_database': 'Test de base de données', 'test_status': 'Test de statut', 'test_console': 'Console de test',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'plugins_desc': 'Installez ou supprimez des plugins optionnels qui étendent les fonctionnalités (ex: drivers de base de données). Type de base de données actuel:',
          'module': 'Module', 'package': 'Paquet', 'install': 'Installer', 'uninstall': 'Désinstaller',
          'installed': 'Installé', 'not_installed': 'Non installé', 'current': 'actuel', 'console_ready': '$ Prêt pour les tests...',
          'test_success': 'SUCCÈS', 'test_failed': 'ÉCHOUÉ', 'test_error': 'ERREUR',
          'config_saved': 'Configuration enregistrée avec succès!',
          'config_save_error': 'Erreur lors de l\'enregistrement de la configuration',
          'scan_kill_btn': 'Effacer les processus orphelins', 'scan_kill_desc': 'Arrêter tous les processus de service en cours d\'exécution',
          'scan_kill_tooltip': 'Menu de service', 'service_menu_tooltip': 'Menu d\'actions du service',
          'scan_kill_confirm_title': 'Confirmer le nettoyage des processus',
          'scan_kill_confirm_msg': 'Ceci terminera tous les processus de service DICOM en cours d\'exécution. Voulez-vous continuer?',
          'scan_kill_scanning': 'Analyse des processus en cours...', 'scan_kill_none': 'Aucun processus de service en cours d\'exécution trouvé.',
          'scan_kill_killed': 'Arrêté {count} processus: {pids}', 'scan_kill_error': 'Erreur lors du nettoyage des processus: {error}',
          'config_error': 'Erreur de configuration', 'config_missing': 'Fichier config.json introuvable',
          'config_invalid': 'Configuration invalide ou incomplète', 'config_check_msg': 'Veuillez vérifier votre configuration dans config.json',
          'config_json_invalid': 'JSON invalide dans config.json',
          'config_view': 'Afficher la configuration',
          'clear_logs_confirm': 'Effacer tous les fichiers journaux?',
          'uninstall_confirm': 'Êtes-vous sûr de vouloir désinstaller ce plugin?',
          'install_pynetdicom_plugin': 'Installer le plugin pynetdicom',
          'title_notifications': 'Notifications', 'title_clear_history': 'Effacer l\'historique', 'title_install_db_driver': 'Installer le pilote DB basé sur config.json'
        },
        zh: {
          'home': '首页', 'config': '配置', 'logs': '日志', 'tests': '测试', 'plugins': '插件',
          'start': '启动', 'stop': '停止', 'restart': '重启', 'recent_logs': '最近的日志', 'back': '返回',
          'save': '保存', 'clear': '清除', 'clear_logs': '清除日志', 'no_logs': '未找到日志', 'language': '语言',
          'theme': '主题', 'status': '状态', 'service_status': '服务状态', 'service_label': '服务',
          'service_starting': '服务启动中...', 'service_started': '服务启动成功', 'service_start_failed': '服务启动失败',
          'service_stopping': '服务停止中...', 'service_stopped': '服务停止成功', 'service_stop_failed': '服务停止失败',
          'service_restarting': '服务重启中...', 'service_restarted': '服务重启成功', 'service_restart_failed': '服务重启失败',
          'service_hint_active': '服务运行中', 'service_hint_stopped': '服务已停止', 'service_hint_unavailable': '服务不可用',
          'test_dcm_echo': 'DICOM C-ECHO测试', 'test_dcm_find': 'DICOM C-FIND测试', 'test_dcm_worklist': '工作列表响应测试',
          'desc_echo': '测试DICOM关联和服务器的回显响应。', 'desc_find': '在DICOM数据库中搜索工作列表项。', 'desc_worklist': '使用真实患者数据测试DICOM C-FIND工作列表响应。',
          'desc_db_conn': '测试数据库连接', 'desc_status': '检查服务是否可访问并响应。',
          'check_availability': '检查可用性', 'test_connection': '测试连接', 'test_worklist': '工作列表响应', 'install_db_driver': '安装数据库驱动程序', 'install_pynetdicom': '安装pynetdicom插件',
          'running_test': '运行测试中...', 'test_passed': '测试通过', 'test_failed': '测试失败', 'output': '输出', 'copy': '复制',
          'running': '运行中', 'stopped': '已停止', 'notifications': '通知', 'no_notifications': '无通知',
          'server_settings': '服务器设置', 'aet_title': 'AE标题', 'aet_title_full': 'DICOM应用实体标题',
          'listen_all_interfaces': '在所有接口上监听', 'host': '主机/IP', 'port': '端口', 'server_port_full': 'DICOM服务器端口',
          'client_aet': '客户端AE', 'client_aet_title_full': '预期的客户端AE标题', 'database_settings': '数据库设置',
          'database_type': '类型', 'database_dsn': 'DSN', 'dsn_hint': '格式: IP:PORT/DB (例: 192.168.1.3:1521/PRD)',
          'database_user': '用户', 'database_password': '密码', 'database_query': '查询', 'sql_hint': '返回工作列表项的SQL查询',
          'sql_guide_title': '工作列表预期列的指南', 'sql_guide_warning': '⚠️ 查询必须按此顺序返回EXACTLY 17列:',
          'sql_guide_link': '查看包含SQL示例的完整指南',
          'sql_col1_hint': '(患者全名)', 'sql_col2_hint': '(唯一标识符)',
          'sql_col5_hint': '(检查描述)', 'sql_col6_hint': '(请求编号)',
          'sql_col9_hint': '(医生全名)', 'sql_col12_hint': '(就诊类型)',
          'sql_col13_hint': '(就诊编号)', 'sql_col14_hint': '(检查地点)',
          'sql_col15_hint': '(程序代码)', 'sql_col16_hint': '(代码意义)',
          'sql_col17_hint': '(编码方案)',
          'error_missing_module': '错误: 找不到模块',
          'test_database': '数据库测试', 'test_status': '状态测试', 'test_console': '测试控制台',
          'plugins_desc': '安装或卸载扩展功能的可选插件 (例如: 数据库驱动程序)。 当前数据库类型:',
          'module': '模块', 'package': '包', 'install': '安装', 'uninstall': '卸载',
          'installed': '已安装', 'not_installed': '未安装', 'current': '当前',
          'console_ready': '$ 准备测试...',
          'test_success': '成功', 'test_failed': '失败', 'test_error': '错误',
          'scan_kill_btn': '清除孤立进程', 'scan_kill_desc': '终止所有运行中的服务进程',
          'scan_kill_tooltip': '服务菜单', 'service_menu_tooltip': '服务操作菜单',
          'scan_kill_confirm_title': '确认清除进程',
          'scan_kill_confirm_msg': '这将终止所有正在运行的DICOM服务进程。 你想继续吗?',
          'scan_kill_scanning': '正在扫描运行中的进程...', 'scan_kill_none': '未发现运行中的服务进程。',
          'scan_kill_killed': '已终止 {count} 个进程: {pids}', 'scan_kill_error': '清除进程时出错: {error}',
          'config_error': '配置错误', 'config_missing': '未找到 config.json 文件',
          'config_invalid': '配置无效或不完整', 'config_check_msg': '请检查 config.json 中的配置',
          'config_json_invalid': 'config.json 中的 JSON 无效',
          'config_view': '查看配置',
          'config_saved': '配置保存成功！',
          'config_save_error': '保存配置时出错',
          'test_success': '成功', 'test_failed': '失败', 'test_error': '错误',
          'clear_logs_confirm': '清除所有日志文件吗?',
          'uninstall_confirm': '确定要卸载此插件吗?',
          'install_pynetdicom_plugin': '安装pynetdicom插件',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'title_notifications': '通知', 'title_clear_history': '清除历史', 'title_install_db_driver': '根据 config.json 安装 DB 驱动程序'
        },
        ru: {
          'home': 'Главная', 'config': 'Конфигурация', 'logs': 'Логи', 'tests': 'Тесты', 'plugins': 'Плагины',
          'start': 'Начать', 'stop': 'Остановить', 'restart': 'Перезагрузить', 'recent_logs': 'Последние логи', 'back': 'Назад',
          'save': 'Сохранить', 'clear': 'Очистить', 'clear_logs': 'Очистить логи', 'no_logs': 'Логи не найдены', 'language': 'Язык',
          'theme': 'Тема', 'status': 'Статус', 'service_status': 'Статус сервиса', 'service_label': 'Сервис',
          'service_starting': 'Сервис запускается...', 'service_started': 'Сервис успешно запущен', 'service_start_failed': 'Ошибка запуска сервиса',
          'service_stopping': 'Сервис останавливается...', 'service_stopped': 'Сервис успешно остановлен', 'service_stop_failed': 'Ошибка остановки сервиса',
          'service_restarting': 'Сервис перезагружается...', 'service_restarted': 'Сервис успешно перезагружен', 'service_restart_failed': 'Ошибка перезагрузки сервиса',
          'service_hint_active': 'Сервис работает', 'service_hint_stopped': 'Сервис остановлен', 'service_hint_unavailable': 'Сервис недоступен',
          'test_dcm_echo': 'Тест DICOM C-ECHO', 'test_dcm_find': 'Тест DICOM C-FIND', 'test_dcm_worklist': 'Тест ответа Worklist',
          'desc_echo': 'Протестируйте ассоциацию DICOM и ответ echo сервера.', 'desc_find': 'Поиск элементов рабочего списка в базе данных DICOM.', 'desc_worklist': 'Тестируйте ответ DICOM C-FIND worklist с реальными данными пациентов.',
          'desc_db_conn': 'Протестируйте подключение к базе данных', 'desc_status': 'Проверьте доступность и отзывчивость сервиса.',
          'check_availability': 'Проверить доступность', 'test_connection': 'Тест подключения', 'test_worklist': 'Ответ Worklist', 'install_db_driver': 'Установить драйвер БД', 'install_pynetdicom': 'Установить плагин pynetdicom',
          'running_test': 'Выполнение теста...', 'test_passed': 'Тест пройден', 'test_failed': 'Тест не пройден', 'output': 'Вывод', 'copy': 'Копировать',
          'running': 'Выполняется', 'stopped': 'Остановлено', 'notifications': 'Уведомления', 'no_notifications': 'Нет уведомлений',
          'server_settings': 'ПАРАМЕТРЫ СЕРВЕРА', 'aet_title': 'Название AE', 'aet_title_full': 'Название DICOM Application Entity',
          'listen_all_interfaces': 'Слушать на всех интерфейсах', 'host': 'Хост/IP', 'port': 'Порт', 'server_port_full': 'Порт DICOM сервера',
          'client_aet': 'AE Клиента', 'client_aet_title_full': 'Ожидаемое название AE клиента', 'database_settings': 'ПАРАМЕТРЫ БАЗЫ ДАННЫХ',
          'database_type': 'Тип', 'database_dsn': 'DSN', 'dsn_hint': 'Формат: IP:PORT/DB (напр: 192.168.1.3:1521/PRD)',
          'database_user': 'Пользователь', 'database_password': 'Пароль', 'database_query': 'Запрос', 'sql_hint': 'SQL запрос, который возвращает элементы рабочего списка',
          'sql_guide_title': 'Руководство по ожидаемым столбцам рабочего списка', 'sql_guide_warning': '⚠️ Запрос должен вернуть РОВНО 17 столбцов в этом порядке:', 'sql_guide_link': 'Полное руководство с примерами SQL',
          'sql_col1_hint': '(Полное имя пациента)', 'sql_col2_hint': '(Уникальный идентификатор)', 'sql_col5_hint': '(Описание исследования)', 'sql_col6_hint': '(Номер заказа)', 'sql_col9_hint': '(Полное имя врача)',
          'sql_col12_hint': '(Тип приема)', 'sql_col13_hint': '(ID приема)', 'sql_col14_hint': '(Место исследования)', 'sql_col15_hint': '(Код процедуры)', 'sql_col16_hint': '(Значение кода)', 'sql_col17_hint': '(Схема кодирования)',
          'error_missing_module': 'Ошибка: Модуль не найден',
          'test_database': 'Тест БД', 'test_status': 'Тест статуса', 'test_console': 'Консоль тестирования',
          'plugins_desc': 'Установите или удалите дополнительные плагины, расширяющие функциональность (напр: драйверы БД). Текущий тип БД:',
          'module': 'Модуль', 'package': 'Пакет', 'install': 'Установить', 'uninstall': 'Удалить',
          'installed': 'Установлено', 'not_installed': 'Не установлено', 'current': 'текущий',
          'console_ready': '$ Готов к тестам...',
          'test_success': 'УСПЕХ', 'test_failed': 'ОШИБКА', 'test_error': 'ОШИБКА',
          'scan_kill_btn': 'Очистить потерянные процессы', 'scan_kill_desc': 'Завершить все выполняемые процессы сервиса',
          'scan_kill_tooltip': 'Меню сервиса', 'service_menu_tooltip': 'Меню действий сервиса',
          'scan_kill_confirm_title': 'Подтвердить очистку процессов',
          'scan_kill_confirm_msg': 'Это завершит все выполняемые процессы сервиса DICOM. Вы хотите продолжить?',
          'scan_kill_scanning': 'Сканирование выполняемых процессов...', 'scan_kill_none': 'Выполняемых процессов сервиса не найдено.',
          'scan_kill_killed': 'Завершено {count} процесс(ов): {pids}', 'scan_kill_error': 'Ошибка при очистке процессов: {error}',
          'config_error': 'Ошибка конфигурации', 'config_missing': 'Файл config.json не найден',
          'config_invalid': 'Конфигурация недействительна или неполна', 'config_check_msg': 'Пожалуйста, проверьте вашу конфигурацию в config.json',
          'config_json_invalid': 'Неверный JSON в config.json',
          'config_view': 'Просмотр конфигурации',
          'config_saved': 'Конфигурация успешно сохранена!',
          'config_save_error': 'Ошибка при сохранении конфигурации',
          'install_pynetdicom_plugin': 'Установить плагин pynetdicom',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'title_notifications': 'Уведомления', 'title_clear_history': 'Очистить историю', 'title_install_db_driver': 'Установить драйвер базы данных на основе config.json',
          'clear_logs_confirm': 'Очистить все файлы логов?',
          'uninstall_confirm': 'Вы уверены, что хотите удалить этот плагин?'
        },
        ja: {
          'home': 'ホーム', 'config': '設定', 'logs': 'ログ', 'tests': 'テスト', 'plugins': 'プラグイン',
          'start': '開始', 'stop': '停止', 'restart': '再起動', 'recent_logs': '最近のログ', 'back': '戻る',
          'save': '保存', 'clear': 'クリア', 'clear_logs': 'ログをクリア', 'no_logs': 'ログが見つかりません', 'language': '言語',
          'theme': 'テーマ', 'status': 'ステータス', 'service_status': 'サービスステータス', 'service_label': 'サービス',
          'service_starting': 'サービス開始中...', 'service_started': 'サービスが正常に開始しました', 'service_start_failed': 'サービスの開始に失敗しました',
          'service_stopping': 'サービス停止中...', 'service_stopped': 'サービスが正常に停止しました', 'service_stop_failed': 'サービスの停止に失敗しました',
          'service_restarting': 'サービス再起動中...', 'service_restarted': 'サービスが正常に再起動しました', 'service_restart_failed': 'サービスの再起動に失敗しました',
          'service_hint_active': 'サービス稼働中', 'service_hint_stopped': 'サービス停止中', 'service_hint_unavailable': 'サービス利用不可',
          'test_dcm_echo': 'DICOM C-ECHOテスト', 'test_dcm_find': 'DICOM C-FINDテスト', 'test_dcm_worklist': 'ワークリスト応答テスト',
          'desc_echo': 'DICOM関連付けとサーバーのエコー応答をテストします。', 'desc_find': 'DICOMデータベースでワークリストアイテムを検索します。', 'desc_worklist': '実患者データを使用してDICOM C-FIND worklist応答をテストします。',
          'desc_db_conn': 'データベース接続をテストします', 'desc_status': 'サービスがアクセス可能で応答しているかを確認します。',
          'check_availability': '可用性を確認', 'test_connection': '接竞をテスト', 'test_worklist': 'Worklist応答', 'install_db_driver': 'DBドライバをインストール', 'install_pynetdicom': 'pynetdicomプラグインをインストール',
          'running_test': 'テスト実行中...', 'test_passed': 'テスト成功', 'test_failed': 'テスト失敗', 'output': '出力', 'copy': 'コピー',
          'running': '実行中', 'stopped': '停止', 'notifications': '通知', 'no_notifications': '通知がありません',
          'server_settings': 'サーバー設定', 'aet_title': 'AEタイトル', 'aet_title_full': 'DICOMアプリケーションエンティティタイトル',
          'listen_all_interfaces': 'すべてのインターフェースをリッスン', 'host': 'ホスト/IP', 'port': 'ポート', 'server_port_full': 'DICOMサーバーポート',
          'client_aet': 'クライアントAE', 'client_aet_title_full': '予想されるクライアントAEタイトル', 'database_settings': 'データベース設定',
          'database_type': 'タイプ', 'database_dsn': 'DSN', 'dsn_hint': '形式: IP:ポート/DB (例: 192.168.1.3:1521/PRD)',
          'database_user': 'ユーザー', 'database_password': 'パスワード', 'database_query': 'クエリ', 'sql_hint': 'ワークリスト項目を返すSQLクエリ',
          'sql_guide_title': 'ワークリストで予想される列のガイド', 'sql_guide_warning': '⚠️ クエリはこの順序で正確に17列を返す必要があります：',
          'sql_guide_link': 'SQL例を含む完全なガイドを表示',
          'sql_col1_hint': '(患者のフルネーム)', 'sql_col2_hint': '(一意識別子)',
          'sql_col5_hint': '(検査説明)', 'sql_col6_hint': '(リクエスト番号)',
          'sql_col9_hint': '(医師のフルネーム)', 'sql_col12_hint': '(受診タイプ)',
          'sql_col13_hint': '(受診ID)', 'sql_col14_hint': '(検査場所)',
          'sql_col15_hint': '(手順コード)', 'sql_col16_hint': '(コードの意味)',
          'sql_col17_hint': '(コーディングスキーム)',
          'error_missing_module': 'エラー: モジュールが見つかりません',
          'test_database': 'データベーステスト', 'test_status': 'ステータステスト', 'test_console': 'テストコンソール',
          'plugins_desc': '機能を拡張するオプションプラグインをインストールまたはアンインストールします (例: DBドライバ)。 現在のDBタイプ:',
          'module': 'モジュール', 'package': 'パッケージ', 'install': 'インストール', 'uninstall': 'アンインストール',
          'installed': 'インストール済み', 'not_installed': 'インストールされていません', 'current': '現在',
          'console_ready': '$ テストの準備完了...',
          'test_success': '成功', 'test_failed': '失敗', 'test_error': 'エラー',
          'scan_kill_btn': '孤立プロセスを削除', 'scan_kill_desc': '実行中のすべてのサービスプロセスを終了する',
          'scan_kill_tooltip': 'サービスメニュー', 'service_menu_tooltip': 'サービスアクションメニュー',
          'scan_kill_confirm_title': 'プロセスクリーンアップを確認',
          'scan_kill_confirm_msg': 'これにより、実行中のすべてのDICOMサービスプロセスが終了します。 続けたいですか?',
          'scan_kill_scanning': '実行中のプロセスをスキャン中...', 'scan_kill_none': '実行中のサービスプロセスが見つかりません。',
          'scan_kill_killed': '{count}個のプロセスを終了しました: {pids}', 'scan_kill_error': 'プロセスのクリア中にエラーが発生しました: {error}',
          'config_error': '設定エラー', 'config_missing': 'config.jsonファイルが見つかりません',
          'config_invalid': '設定が無効または不完全です', 'config_check_msg': 'config.jsonの設定を確認してください',
          'config_json_invalid': 'config.jsonのJSONが無効です',
          'config_view': '設定を表示',
          'config_saved': '設定が正常に保存されました！',
          'config_save_error': '設定の保存中にエラーが発生しました',
          'install_pynetdicom_plugin': 'pynetdicomプラグインをインストール',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'title_notifications': '通知', 'title_clear_history': '履歴を消去', 'title_install_db_driver': 'config.json に基づいて DB ドライバーをインストール',
          'clear_logs_confirm': 'すべてのログファイルをクリアしますか?',
          'uninstall_confirm': 'このプラグインをアンインストールしてもよろしいですか?'
        },
        it: {
          'home': 'Home', 'config': 'Configurazione', 'logs': 'Log', 'tests': 'Test', 'plugins': 'Plugin',
          'start': 'Avvia', 'stop': 'Arresta', 'restart': 'Riavvia', 'recent_logs': 'Log Recenti', 'back': 'Indietro',
          'save': 'Salva', 'clear': 'Cancella', 'clear_logs': 'Cancella log', 'no_logs': 'Nessun log trovato', 'language': 'Lingua',
          'theme': 'Tema', 'status': 'Stato', 'service_status': 'Stato del Servizio', 'service_label': 'Servizio',
          'service_starting': 'Servizio in avvio...', 'service_started': 'Servizio avviato con successo', 'service_start_failed': 'Errore nell\'avvio del servizio',
          'service_stopping': 'Servizio in arresto...', 'service_stopped': 'Servizio arrestato con successo', 'service_stop_failed': 'Errore nell\'arresto del servizio',
          'service_restarting': 'Servizio in riavvio...', 'service_restarted': 'Servizio riavviato con successo', 'service_restart_failed': 'Errore nel riavvio del servizio',
          'service_hint_active': 'Servizio attivo', 'service_hint_stopped': 'Servizio fermo', 'service_hint_unavailable': 'Servizio non disponibile',
          'test_dcm_echo': 'Test DICOM C-ECHO', 'test_dcm_find': 'Test DICOM C-FIND', 'test_dcm_worklist': 'Test de réponse Worklist',
          'desc_echo': 'Testare l\'associazione DICOM e la risposta di echo del server.', 'desc_find': 'Ricerca di elementi dell\'elenco di lavoro nel database DICOM.', 'desc_worklist': 'Testare la risposta DICOM C-FIND worklist con dati pazienti reali.',
          'desc_db_conn': 'Testare la connettività del database', 'desc_status': 'Verificare se il servizio è accessibile e risponde.',
          'check_availability': 'Verifica disponibilità', 'test_connection': 'Testa connessione', 'test_worklist': 'Risposta Worklist', 'install_db_driver': 'Installa driver database', 'install_pynetdicom': 'Installa plugin pynetdicom',
          'running_test': 'Test in esecuzione...', 'test_passed': 'Test superato', 'test_failed': 'Test non superato', 'output': 'Output', 'copy': 'Copia',
          'running': 'In esecuzione', 'stopped': 'Arrestato', 'notifications': 'Notifiche', 'no_notifications': 'Nessuna notifica',
          'server_settings': 'IMPOSTAZIONI SERVER', 'aet_title': 'Titolo AE', 'aet_title_full': 'Titolo DICOM Application Entity',
          'listen_all_interfaces': 'Ascolta su tutte le interfacce', 'host': 'Host/IP', 'port': 'Porta', 'server_port_full': 'Porta server DICOM',
          'client_aet': 'AE Client', 'client_aet_title_full': 'Titolo AE client previsto', 'database_settings': 'IMPOSTAZIONI DATABASE',
          'database_type': 'Tipo', 'database_dsn': 'DSN', 'dsn_hint': 'Formato: IP:PORT/DB (es: 192.168.1.3:1521/PRD)',
          'database_user': 'Utente', 'database_password': 'Password', 'database_query': 'Query', 'sql_hint': 'Query SQL che restituisce gli elementi dell\'elenco di lavoro',
          'sql_guide_title': 'Guida alle colonne previste dell\'elenco di lavoro', 'sql_guide_warning': '⚠️ La query deve restituire ESATTAMENTE 17 colonne in questo ordine:', 'sql_guide_link': 'Guida completa con esempi SQL',
          'sql_col1_hint': '(Nome completo del paziente)', 'sql_col2_hint': '(Identificatore unico)', 'sql_col5_hint': '(Descrizione dell\'esame)', 'sql_col6_hint': '(Numero ordine)', 'sql_col9_hint': '(Nome completo del medico)',
          'sql_col12_hint': '(Tipo di ammissione)', 'sql_col13_hint': '(ID ammissione)', 'sql_col14_hint': '(Luogo dell\'esame)', 'sql_col15_hint': '(Codice procedura)', 'sql_col16_hint': '(Significato del codice)', 'sql_col17_hint': '(Schema di codifica)',
          'error_missing_module': 'Errore: Modulo non trovato',
          'test_database': 'Test Database', 'test_status': 'Test di stato', 'test_console': 'Console di test',
          'plugins_desc': 'Installa o disinstalla plugin opzionali che estendono la funzionalità (es: driver database). Tipo DB attuale:',
          'module': 'Modulo', 'package': 'Pacchetto', 'install': 'Installa', 'uninstall': 'Disinstalla',
          'installed': 'Installato', 'not_installed': 'Non installato', 'current': 'attuale',
          'console_ready': '$ Pronto per i test...',
          'test_success': 'SUCCESSO', 'test_failed': 'FALLITO', 'test_error': 'ERRORE',
          'scan_kill_btn': 'Cancella processi orfani', 'scan_kill_desc': 'Termina tutti i processi di servizio in esecuzione',
          'scan_kill_tooltip': 'Menu servizio', 'service_menu_tooltip': 'Menu azioni servizio',
          'scan_kill_confirm_title': 'Conferma pulizia processi',
          'scan_kill_confirm_msg': 'Questo terminerà tutti i processi di servizio DICOM in esecuzione. Vuoi continuare?',
          'scan_kill_scanning': 'Scansione dei processi in esecuzione...', 'scan_kill_none': 'Nessun processo di servizio in esecuzione trovato.',
          'scan_kill_killed': 'Terminati {count} processo(i): {pids}', 'scan_kill_error': 'Errore durante la pulizia dei processi: {error}',
          'config_error': 'Errore di configurazione', 'config_missing': 'File config.json non trovato',
          'config_invalid': 'Configurazione non valida o incompleta', 'config_check_msg': 'Si prega di controllare la configurazione in config.json',
          'config_json_invalid': 'JSON non valido in config.json',
          'config_view': 'Visualizza configurazione',
          'install_pynetdicom_plugin': 'Installa plugin pynetdicom',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'title_notifications': 'Notifiche', 'title_clear_history': 'Cancella cronologia', 'title_install_db_driver': 'Installa driver database basato su config.json',
          'clear_logs_confirm': 'Cancellare tutti i file di log?',
          'uninstall_confirm': 'Sei sicuro di voler disinstallare questo plugin?'
        },
        tr: {
          'home': 'Anasayfa', 'config': 'Yapılandırma', 'logs': 'Günlükler', 'tests': 'Testler', 'plugins': 'Eklentiler',
          'start': 'Başlat', 'stop': 'Durdur', 'restart': 'Yeniden Başlat', 'recent_logs': 'Son Günlükler', 'back': 'Geri',
          'save': 'Kaydet', 'clear': 'Temizle', 'clear_logs': 'Günlükleri Temizle', 'no_logs': 'Günlük bulunamadı', 'language': 'Dil',
          'theme': 'Tema', 'status': 'Durum', 'service_status': 'Hizmet Durumu', 'service_label': 'Hizmet',
          'service_starting': 'Hizmet başlatılıyor...', 'service_started': 'Hizmet başarıyla başlatıldı', 'service_start_failed': 'Hizmet başlatılamadı',
          'service_stopping': 'Hizmet durduruluyor...', 'service_stopped': 'Hizmet başarıyla durduruldu', 'service_stop_failed': 'Hizmet durdurulamadı',
          'service_restarting': 'Hizmet yeniden başlatılıyor...', 'service_restarted': 'Hizmet başarıyla yeniden başlatıldı', 'service_restart_failed': 'Hizmet yeniden başlatılamadı',
          'service_hint_active': 'Hizmet çalışıyor', 'service_hint_stopped': 'Hizmet durdu', 'service_hint_unavailable': 'Hizmet kullanılamıyor',
          'test_dcm_echo': 'DICOM C-ECHO Testi', 'test_dcm_find': 'DICOM C-FIND Testi', 'test_dcm_worklist': 'Worklist Yanıt Testi',
          'desc_echo': 'DICOM ilişkilendirmesi ve sunucu echo yanıtını test edin.', 'desc_find': 'DICOM veritabanında çalışma listesi öğelerini arayın.', 'desc_worklist': 'Gerçek hasta verileri ile DICOM C-FIND worklist yanıtını test edin.',
          'desc_db_conn': 'Veritabanı bağlantısını test edin', 'desc_status': 'Hizmetin erişilebilir ve yanıt verip vermediğini kontrol edin.',
          'check_availability': 'Kullanılabilirliği Kontrol Et', 'test_connection': 'Bağlantıyı Test Et', 'test_worklist': 'Worklist Yanıtı', 'install_db_driver': 'Veritabanı Sürücsünü Yükle', 'install_pynetdicom': 'pynetdicom Eklentisini Yükle',
          'running_test': 'Test çalışıyor...', 'test_passed': 'Test başarıyla geçti', 'test_failed': 'Test başarısız oldu', 'output': 'Çıktı', 'copy': 'Kopyala',
          'running': 'Çalışıyor', 'stopped': 'Durduruldu', 'notifications': 'Bildirimler', 'no_notifications': 'Bildirim yok',
          'server_settings': 'SUNUCU AYARLARI', 'aet_title': 'AE Başlığı', 'aet_title_full': 'DICOM Uygulama Kuruluşu Başlığı',
          'listen_all_interfaces': 'Tüm arabirimlerde dinle', 'host': 'Ana Bilgisayar/IP', 'port': 'Port', 'server_port_full': 'DICOM sunucu portu',
          'client_aet': 'İstemci AE', 'client_aet_title_full': 'Beklenen istemci AE başlığı', 'database_settings': 'VERİTABANI AYARLARI',
          'database_type': 'Tür', 'database_dsn': 'DSN', 'dsn_hint': 'Biçim: IP:PORT/DB (örn: 192.168.1.3:1521/PRD)',
          'database_user': 'Kullanıcı', 'database_password': 'Şifre', 'database_query': 'Sorgu', 'sql_hint': 'Çalışma listesi öğelerini döndüren SQL sorgusu',
          'sql_guide_title': 'Çalışma listesi tarafından beklenen sütunlara kılavuz', 'sql_guide_warning': '⚠️ Sorgu bu sırada TAM OLARAK 17 sütun döndürmelidir:', 'sql_guide_link': 'SQL örnekleri ile tam kılavuz',
          'sql_col1_hint': '(Hastanın tam adı)', 'sql_col2_hint': '(Benzersiz tanımlayıcı)', 'sql_col5_hint': '(İnceleme açıklaması)', 'sql_col6_hint': '(Sipariş numarası)', 'sql_col9_hint': '(Doktorun tam adı)',
          'sql_col12_hint': '(Kabul türü)', 'sql_col13_hint': '(Kabul kimliği)', 'sql_col14_hint': '(İnceleme yeri)', 'sql_col15_hint': '(İşlem kodu)', 'sql_col16_hint': '(Kod anlamı)', 'sql_col17_hint': '(Kodlama şeması)',
          'error_missing_module': 'Hata: Modül bulunamadı',
          'test_database': 'Veritabanı Testi', 'test_status': 'Durum Testi', 'test_console': 'Test Konsolu',
          'plugins_desc': 'İşlevsellieği genişleten isteğe bağlı eklentileri yükleyin veya kaldırın (örn: veritabanı sürücüleri). Güncel DB türü:',
          'module': 'Modül', 'package': 'Paket', 'install': 'Yükle', 'uninstall': 'Kaldır',
          'installed': 'Yüklü', 'not_installed': 'Yüklü değil', 'current': 'mevcut',
          'console_ready': '$ Testler için hazır...',
          'test_success': 'BAŞARILI', 'test_failed': 'BAŞARISIZ', 'test_error': 'HATA',
          'scan_kill_btn': 'Yetim işlemleri temizle', 'scan_kill_desc': 'Çalışan tüm hizmet işlemlerini sonlandır',
          'scan_kill_tooltip': 'Hizmet menüsü', 'service_menu_tooltip': 'Hizmet eylem menüsü',
          'scan_kill_confirm_title': 'İşlem Temizliğini Onayla',
          'scan_kill_confirm_msg': 'Bu, çalışan tüm DICOM hizmet işlemlerini sonlandıracaktır. Devam etmek istiyor musunuz?',
          'scan_kill_scanning': 'Çalışan işlemler taranıyor...', 'scan_kill_none': 'Çalışan hizmet işlemi bulunamadı.',
          'scan_kill_killed': '{count} işlem sonlandırıldı: {pids}', 'scan_kill_error': 'İşlemleri temizlerken hata oluştu: {error}',
          'config_error': 'Yapılandırma Hatası', 'config_missing': 'config.json dosyası bulunamadı',
          'config_invalid': 'Yapılandırma geçersiz veya eksik', 'config_check_msg': 'Lütfen config.json içinde yapılandırmanızı kontrol edin',
          'config_json_invalid': 'config.json içinde geçersiz JSON',
          'config_view': 'Yapılandırmayı görüntüle',
          'install_pynetdicom_plugin': 'pynetdicom Eklentisini Yükle',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'title_notifications': 'Bildirimler', 'title_clear_history': 'Geçmişi Temizle', 'title_install_db_driver': 'config.json ̓e Göre Veritabanı Sürücsünü Yükle',
          'clear_logs_confirm': 'Tüm günlük dosyalarını temizle?',
          'uninstall_confirm': 'Bu eklentiyi kaldırmak istediğinizden emin misiniz?'
        },
        fil: {
          'home': 'Tahanan', 'config': 'Pagsasaayos', 'logs': 'Mga Log', 'tests': 'Mga Pagsubok', 'plugins': 'Mga Plugin',
          'start': 'Magsimula', 'stop': 'Huminto', 'restart': 'I-restart', 'recent_logs': 'Mga Kamakailang Log', 'back': 'Bumalik',
          'save': 'I-save', 'clear': 'Burahin', 'clear_logs': 'Burahin ang mga Log', 'no_logs': 'Walang nakitang log', 'language': 'Wika',
          'theme': 'Tema', 'status': 'Katayuan', 'service_status': 'Katayuan ng Serbisyo', 'service_label': 'Serbisyo',
          'service_starting': 'Nagsisimula ang serbisyo...', 'service_started': 'Matagumpay na nagsimula ang serbisyo', 'service_start_failed': 'Nabigo ang paglunsad ng serbisyo',
          'service_stopping': 'Titigil ang serbisyo...', 'service_stopped': 'Matagumpay na tumitigil ang serbisyo', 'service_stop_failed': 'Nabigo ang paghinto ng serbisyo',
          'service_restarting': 'Nag-restart ang serbisyo...', 'service_restarted': 'Matagumpay na nag-restart ang serbisyo', 'service_restart_failed': 'Nabigo ang pag-restart ng serbisyo',
          'service_hint_active': 'Nakaandar ang serbisyo', 'service_hint_stopped': 'Huminto ang serbisyo', 'service_hint_unavailable': 'Hindi magamit ang serbisyo',
          'test_dcm_echo': 'DICOM C-ECHO Pagsubok', 'test_dcm_find': 'DICOM C-FIND Pagsubok', 'test_dcm_worklist': 'Pagsubok ng Tugon ng Worklist',
          'desc_echo': 'Subukan ang DICOM association at echo response ng server.', 'desc_find': 'Maghanap ng worklist items sa DICOM database.', 'desc_worklist': 'Subukan ang DICOM C-FIND worklist response gamit ang tunay na patient data.',
          'desc_db_conn': 'Subukan ang database connectivity', 'desc_status': 'Suriin kung ang serbisyo ay accessible at tumutugon.',
          'check_availability': 'Suriin ang Pagkakaroon', 'test_connection': 'Subukan ang Koneksyon', 'test_worklist': 'Worklist Response', 'install_db_driver': 'I-install ang DB Driver', 'install_pynetdicom': 'I-install ang pynetdicom Plugin', 'install_pynetdicom': 'I-install ang pynetdicom Plugin',
          'running_test': 'Tumatakbo ang pagsubok...', 'test_passed': 'Ang pagsubok ay lumampas', 'test_failed': 'Ang pagsubok ay nabigo', 'output': 'Output', 'copy': 'Kopyahin',
          'running': 'Tumatakbo', 'stopped': 'Tumitigil', 'notifications': 'Mga Notipikasyon', 'no_notifications': 'Walang notipikasyon',
          'server_settings': 'MGA SETTING NG SERVER', 'aet_title': 'AE Title', 'aet_title_full': 'DICOM Application Entity Title',
          'listen_all_interfaces': 'Makinig sa lahat ng interface', 'host': 'Host/IP', 'port': 'Port', 'server_port_full': 'DICOM server port',
          'client_aet': 'Client AE', 'client_aet_title_full': 'Inaasahang client AE Title', 'database_settings': 'MGA SETTING NG DATABASE',
          'database_type': 'Uri', 'database_dsn': 'DSN', 'dsn_hint': 'Format: IP:PORT/DB (hal: 192.168.1.3:1521/PRD)',
          'database_user': 'User', 'database_password': 'Password', 'database_query': 'Query', 'sql_hint': 'SQL query na nagbabalik ng worklist items',
          'sql_guide_title': 'Gabay sa inaasahang column ng worklist', 'sql_guide_warning': '⚠️ Ang query ay dapat magbalik ng EKSAKTO 17 kolum sa pagkakasunod-sunod na ito:', 'sql_guide_link': 'Kumpleto gabay na may mga SQL halimbawa',
          'sql_col1_hint': '(Buong pangalan ng pasyente)', 'sql_col2_hint': '(Kakaibang pagkakakilanlan)', 'sql_col5_hint': '(Paglalarawan ng eksaminasyon)', 'sql_col6_hint': '(Numero ng order)', 'sql_col9_hint': '(Buong pangalan ng doktor)',
          'sql_col12_hint': '(Uri ng admission)', 'sql_col13_hint': '(ID ng admission)', 'sql_col14_hint': '(Lokasyon ng eksaminasyon)', 'sql_col15_hint': '(Code ng pamamaraan)', 'sql_col16_hint': '(Kahulugan ng code)', 'sql_col17_hint': '(Coding scheme)',
          'error_missing_module': 'Error: Module not found',
          'test_database': 'Database Test', 'test_status': 'Status Test', 'test_console': 'Test Console',
          'plugins_desc': 'I-install o alisin ang optional plugins na nagpapalakas ng functionality (hal: database drivers). Kasalukuyang DB type:',
          'module': 'Module', 'package': 'Package', 'install': 'I-install', 'uninstall': 'I-uninstall',
          'installed': 'Naka-install', 'not_installed': 'Hindi naka-install', 'current': 'kasalukuyan',
          'console_ready': '$ Handa para sa mga pagsubok...',
          'test_success': 'TAGUMPAY', 'test_failed': 'NABIGO', 'test_error': 'KAMALIAN',
          'scan_kill_btn': 'Burahin ang orphan processes', 'scan_kill_desc': 'Aksyunan ang lahat ng tumatakbong service processes',
          'scan_kill_tooltip': 'Service menu', 'service_menu_tooltip': 'Service action menu',
          'scan_kill_confirm_title': 'Kumpirmahin ang Process Cleanup',
          'scan_kill_confirm_msg': 'Ito ay magtatapos ng lahat ng tumatakbong DICOM service processes. Gusto mo bang magpatuloy?',
          'scan_kill_scanning': 'Sinuscan ang tumatakbong processes...', 'scan_kill_none': 'Walang tumatakbong service process na nahanap.',
          'scan_kill_killed': 'Nawasakan {count} process(es): {pids}', 'scan_kill_error': 'Kamalian sa pag-clear ng processes: {error}',
          'config_error': 'Kamalian sa Pagsasaayos', 'config_missing': 'Ang config.json file ay hindi nahanap',
          'config_invalid': 'Ang pagsasaayos ay hindi wasto o hindi kumpleto', 'config_check_msg': 'Mangyaring suriin ang inyong pagsasaayos sa config.json',
          'config_json_invalid': 'Ang JSON sa config.json ay hindi wasto',
          'config_view': 'Tingnan ang Pagsasaayos',
          'install_pynetdicom_plugin': 'I-install ang pynetdicom Plugin',
          'db_type_oracle': 'Oracle', 'db_type_postgresql': 'PostgreSQL', 'db_type_mysql': 'MySQL',
          'title_notifications': 'Mga Notipikasyon', 'title_clear_history': 'Burahin ang kasaysayan', 'title_install_db_driver': 'I-install ang DB Driver base sa config.json',
          'clear_logs_confirm': 'Burahin ang lahat ng log files?',
          'uninstall_confirm': 'Sigurado ka na gustong i-uninstall ang plugin na ito?'
        }
      };

      let currentLang = localStorage.getItem('lang') || 'en';

      function t(key) {
        return translations[currentLang]?.[key] || key;
      }

      function setLang(lang) {
        localStorage.setItem('lang', lang);
        currentLang = lang;
        document.getElementById('langCode').textContent = lang.toUpperCase();
        document.querySelectorAll('[data-i18n]').forEach(el => {
          el.textContent = t(el.dataset.i18n);
        });
        document.querySelectorAll('[data-i18n-title]').forEach(el => {
          el.title = t(el.dataset.i18nTitle);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          el.placeholder = t(el.dataset.i18nPlaceholder);
        });
        document.querySelectorAll('[data-i18n-value]').forEach(el => {
          el.value = t(el.dataset.i18nValue);
        });

        // Persist server-side so MWLSCP picks it up for logs
        fetch('/set-language', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lang })
        }).catch(() => {});
      }

      // Fixed theme: keep light theme by default

      function showNotification(message, type = 'info', duration = 4000, persist = true) {
        const notification = document.createElement('div');
        notification.className = `notification notification-enter p-4 rounded-lg shadow-lg text-white ${
          type === 'success' ? 'bg-green-500' :
          type === 'error' ? 'bg-red-500' :
          type === 'warning' ? 'bg-yellow-500' :
          'bg-blue-500'
        }`;
        notification.innerHTML = `
          <div class="flex items-center gap-3">
            <i class="fas ${
              type === 'success' ? 'fa-check-circle' :
              type === 'error' ? 'fa-times-circle' :
              type === 'warning' ? 'fa-exclamation-circle' :
              'fa-info-circle'
            }"></i>
            <span>${message}</span>
          </div>
        `;
        
        // Calculate position based on existing notifications
        const existingNotifications = document.querySelectorAll('.notification');
        let topPosition = 80; // Initial position
        existingNotifications.forEach(notif => {
          topPosition += notif.offsetHeight + 10; // Add height + spacing
        });
        notification.style.top = `${topPosition}px`;
        
        document.body.appendChild(notification);
        
        // Add to notification history unless explicitly disabled
        if (persist) {
          addNotificationToHistory(message, type);
        }
        
        setTimeout(() => {
          notification.classList.remove('notification-enter');
          notification.classList.add('notification-exit');
          setTimeout(() => {
            notification.remove();
            // Reposition remaining notifications
            repositionNotifications();
          }, 300);
        }, duration);
      }
      
      function repositionNotifications() {
        const notifications = document.querySelectorAll('.notification');
        let topPosition = 80;
        notifications.forEach(notif => {
          notif.style.top = `${topPosition}px`;
          topPosition += notif.offsetHeight + 10;
        });
      }

      // Notification history system
      let notificationHistory = JSON.parse(localStorage.getItem('notificationHistory') || '[]');
      let unreadCount = parseInt(localStorage.getItem('unreadNotifications') || '0');

      function addNotificationToHistory(message, type) {
        const notif = {
          id: Date.now(),
          message: message,
          type: type,
          timestamp: new Date().toLocaleTimeString('pt-BR'),
          read: false
        };
        
        notificationHistory.unshift(notif);
        if (notificationHistory.length > 20) notificationHistory.pop();
        
        unreadCount++;
        localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
        localStorage.setItem('unreadNotifications', unreadCount.toString());
        
        updateNotificationBadge();
      }

      function updateNotificationBadge() {
        const badge = document.getElementById('notification-badge');
        const bell = document.getElementById('notification-bell');
        
        if (unreadCount > 0) {
          if (badge) {
            badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            badge.classList.remove('hidden');
          }
        } else {
          if (badge) badge.classList.add('hidden');
        }
      }

      function toggleNotificationDropdown() {
        const dropdown = document.getElementById('notification-dropdown');
        dropdown.classList.toggle('show');
        
        if (dropdown.classList.contains('show')) {
          markAllNotificationsAsRead();
        }
      }

      function markAllNotificationsAsRead() {
        notificationHistory.forEach(n => n.read = true);
        unreadCount = 0;
        localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
        localStorage.setItem('unreadNotifications', '0');
        updateNotificationBadge();
        renderNotificationHistory();
      }

      function clearNotificationHistory() {
        notificationHistory = [];
        unreadCount = 0;
        localStorage.setItem('notificationHistory', '[]');
        localStorage.setItem('unreadNotifications', '0');
        updateNotificationBadge();
        renderNotificationHistory();
      }

      function renderNotificationHistory() {
        const container = document.getElementById('notification-history');
        if (!container) return;
        
        if (notificationHistory.length === 0) {
          container.innerHTML = `<div class="p-4 text-center text-gray-500 dark:text-gray-400" data-i18n="no_notifications">Nenhuma notificação</div>`;
          return;
        }
        
        container.innerHTML = notificationHistory.map(n => {
          const typeIcons = {
            success: 'fa-check-circle text-green-500',
            error: 'fa-times-circle text-red-500',
            warning: 'fa-exclamation-circle text-yellow-500',
            info: 'fa-info-circle text-blue-500'
          };
          
          return `
            <div class="notification-item ${!n.read ? 'unread' : ''}">
              <div class="flex items-start gap-3">
                <i class="fas ${typeIcons[n.type] || typeIcons.info} mt-1"></i>
                <div class="flex-1">
                  <p class="text-gray-900 dark:text-white text-sm">${n.message}</p>
                  <p class="notification-item-time">${n.timestamp}</p>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      // Processing indicator and loading bar functions
      window._activeRequests = 0;
      // Gate to show loading bar only during user actions
      window._showLoadingBar = false;
      
      function setProcessingIndicator() {
        const dot = document.getElementById('svc-health-dot');
        if (!dot) return;
        
        // Only add pulse animation if requests are active AND service is running (green dot)
        const isServiceRunning = dot.classList.contains('bg-green-500');
        
        if (window._activeRequests > 0 && isServiceRunning) {
          // Add yellow ring with pulse while processing (only if service is running)
          dot.classList.add('ring-4', 'ring-yellow-400', 'animate-pulse');
        } else {
          // Remove yellow ring and pulse when done or service stopped
          dot.classList.remove('ring-4', 'ring-yellow-400', 'animate-pulse');
        }
      }

      let _loadingTimer = null;

      function showLoadingBar() {
        let bar = document.getElementById('loading-bar');
        if (!bar) {
          bar = document.createElement('div');
          bar.id = 'loading-bar';
          bar.style.cssText = 'position: fixed; top: 0; left: 0; height: 3px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); z-index: 9999; transition: width 0.25s ease, opacity 0.4s ease;';
          document.body.appendChild(bar);
        }
        // Reset and start smooth progress
        bar.style.opacity = '1';
        bar.style.width = '10%';
        if (_loadingTimer) clearInterval(_loadingTimer);
        _loadingTimer = setInterval(() => {
          const current = parseFloat(bar.style.width);
          const next = Math.min(90, current + Math.random() * 12 + 5);
          bar.style.width = `${next}%`;
          if (next >= 90) {
            clearInterval(_loadingTimer);
            _loadingTimer = null;
          }
        }, 200);
      }
      
      function hideLoadingBar() {
        const bar = document.getElementById('loading-bar');
        if (_loadingTimer) {
          clearInterval(_loadingTimer);
          _loadingTimer = null;
        }
        if (bar) {
          bar.style.width = '100%';
          setTimeout(() => {
            bar.style.opacity = '0';
            bar.style.transition = 'opacity 0.4s ease';
            // Fully remove the bar after fade to avoid lingering overlay
            setTimeout(() => { try { bar.remove(); } catch(e) {} }, 400);
          }, 150);
        }
      }

      // Fetch/XHR interception - GLOBAL
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        window._activeRequests += 1;
        setProcessingIndicator();
        if (window._showLoadingBar) {
          showLoadingBar();
        }
        return originalFetch.apply(this, args)
          .then(response => {
            window._activeRequests = Math.max(0, window._activeRequests - 1);
            setProcessingIndicator();
            if (window._showLoadingBar) {
              hideLoadingBar();
            }
            return response;
          })
          .catch(error => {
            window._activeRequests = Math.max(0, window._activeRequests - 1);
            setProcessingIndicator();
            if (window._showLoadingBar) {
              hideLoadingBar();
            }
            try {
              const url = (args && args[0] && args[0].toString()) || '';
              const isStatusPoll = typeof url === 'string' && url.includes('/status');
              // Silence noisy logs for background status polls; still log other errors
              if (!isStatusPoll) {
                console.error('fetch error:', error);
              }
            } catch (e) {}
            throw error;
          });
      };
      
      const originalOpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(...args) {
        window._activeRequests += 1;
        setProcessingIndicator();
        if (window._showLoadingBar) {
          showLoadingBar();
        }
        return originalOpen.apply(this, args);
      };
      
      const originalSend = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.send = function(...args) {
        this.addEventListener('load', () => {
          window._activeRequests = Math.max(0, window._activeRequests - 1);
          setProcessingIndicator();
          if (window._showLoadingBar) {
            hideLoadingBar();
          }
        });
        this.addEventListener('error', () => {
          window._activeRequests = Math.max(0, window._activeRequests - 1);
          setProcessingIndicator();
          if (window._showLoadingBar) {
            hideLoadingBar();
          }
        });
        this.addEventListener('abort', () => {
          window._activeRequests = Math.max(0, window._activeRequests - 1);
          setProcessingIndicator();
          if (window._showLoadingBar) {
            hideLoadingBar();
          }
        });
        return originalSend.apply(this, args);
      };

      // Service action functions - GLOBALLY AVAILABLE
      async function executeAction(action) {
        try {
          console.info('executeAction', action);
          // Show loading bar only for user-triggered actions
          window._showLoadingBar = true;
          showLoadingBar();
          if (['start', 'restart'].includes(action)) {
            window.serviceTransition = action;
            setTimeout(() => { if (window.serviceTransition === action) window.serviceTransition = null; }, 12000);
          }
          const startingMsg = {
            'start': t('service_starting'),
            'stop': t('service_stopping'),
            'restart': t('service_restarting')
          };
          // Ephemeral status for action begin (do not persist in history)
          showNotification(startingMsg[action] || `Executing ${action}...`, 'info', 3000, false);

          const response = await fetch(`/action/${action}`, { method: 'POST' });
          const raw = await response.text();
          let data;
          try {
            data = raw ? JSON.parse(raw) : {};
          } catch (e) {
            console.error('action json parse error', e, raw);
            data = { ok: false, msg: 'Invalid JSON response', error_detail: raw };
          }

          if (data.ok) {
            const successMsg = {
              'start': t('service_started'),
              'stop': t('service_stopped'),
              'restart': t('service_restarted')
            };
            // Success notice is ephemeral; keep history clean
            showNotification(successMsg[action] || 'OK', 'success', 5000, false);
            if (typeof updateStatus === 'function') {
              setTimeout(updateStatus, 500);
              setTimeout(updateStatus, 2000);
            }
          } else {
            let errorDetail = data.error_detail || data.msg || raw || 'Erro desconhecido';
            const errorMsg = {
              'start': t('service_start_failed'),
              'stop': t('service_stop_failed'),
              'restart': t('service_restart_failed')
            };

            if (data.error_type === 'config_error' || response.status === 400) {
              const configError = `${t('config_error')}: ${errorDetail}\n${t('config_check_msg')}`;
              showNotification(configError, 'error', 8000);
            } else {
              const typeTag = data.error_type ? `[${data.error_type}] ` : '';
              const msg = `${errorMsg[action] || 'Erro'}: ${typeTag}${errorDetail}`;
              showNotification(msg, 'error', 7000);
            }
            if (typeof updateStatus === 'function') {
              setTimeout(updateStatus, 1000);
            }
          }
        } catch (err) {
          console.error('executeAction error', err);
          showNotification(`⚠️ ${err.message}`, 'error', 5000);
          if (typeof updateStatus === 'function') {
            setTimeout(updateStatus, 1000);
          }
        } finally {
          // Ensure loading bar is hidden and flag reset
          hideLoadingBar();
          window._showLoadingBar = false;
        }
      }

      function confirmScanAndKill() {
        const confirmMsg = t('scan_kill_confirm_msg') || 'Isto irá encerrar todos os processos do serviço DICOM em execução. Deseja continuar?';
        const confirmTitle = t('scan_kill_confirm_title') || 'Confirmar Limpeza de Processos';

        if (confirm(`${confirmTitle}\n\n${confirmMsg}`)) {
          scanAndKill();
        }
      }

      function confirmScanAndKillOthers() {
        const title = 'Limpar outras instâncias';
        const msg = 'Isto irá encerrar processos do app/serviço que pertencem a outras instâncias/cópias. Deseja continuar?';
        if (confirm(`${title}\n\n${msg}`)) {
          scanAndKillOthers();
        }
      }

      async function scanAndKillOthers() {
        try {
          window._showLoadingBar = true;
          showLoadingBar();
          showNotification('Procurando e encerrando outras instâncias...', 'info');
          const response = await fetch('/service/scan-kill-others', { method: 'POST' });
          const raw = await response.text();
          let data = {};
          try { data = raw ? JSON.parse(raw) : {}; } catch (e) { console.error('scan-kill-others json parse error', e, raw); }
          if (data.ok) {
            const svc = (data.killed && data.killed.service) ? data.killed.service.length : 0;
            const app = (data.killed && data.killed.app) ? data.killed.app.length : 0;
            const total = svc + app;
            const msg = total > 0 ? `Encerradas ${total} tarefa(s) de outras instâncias (service: ${svc}, app: ${app}).` : 'Nenhuma outra instância encontrada.';
            showNotification(msg, 'success', 6000);
            if (typeof updateStatus === 'function') {
              setTimeout(updateStatus, 1200);
            }
          } else {
            const err = (data.errors || []).join('; ') || data.msg || 'Erro desconhecido';
            showNotification(`Falha ao limpar outras instâncias: ${err}`, 'error', 6000);
          }
        } catch (err) {
          showNotification(`⚠️ ${err.message}`, 'error', 6000);
        } finally {
          hideLoadingBar();
          window._showLoadingBar = false;
        }
      }

      async function scanAndKill() {
        try {
          window._showLoadingBar = true;
          showLoadingBar();
          showNotification(t('scan_kill_scanning'), 'info');
          const response = await fetch('/service/scan-kill', { method: 'POST' });
          const raw = await response.text();
          let data = {};
          try { data = raw ? JSON.parse(raw) : {}; } catch (e) { console.error('scan-kill json parse error', e, raw); }
          if (data.ok) {
            const killed = (data.killed || []).length;
            const msg = killed > 0
              ? t('scan_kill_killed').replace('{count}', killed).replace('{pids}', data.killed.join(', '))
              : t('scan_kill_none');
            showNotification(msg, 'success', 6000);
            setTimeout(() => location.reload(), 1200);
          } else {
            const msg = t('scan_kill_error').replace('{error}', data.msg || 'Unknown error');
            showNotification(`⚠️ ${msg}`, 'error', 6000);
          }
        } catch (err) {
          showNotification(`⚠️ ${err.message}`, 'error', 6000);
        } finally {
          hideLoadingBar();
          window._showLoadingBar = false;
        }
      }

      // Initialize history on page load
      window.addEventListener('DOMContentLoaded', () => {
        setLang(currentLang);
        updateNotificationBadge();
        renderNotificationHistory();

        setupNavLoading();

        // Fechar dropdown quando clicar fora
        document.addEventListener('click', (e) => {
          const dropdown = document.getElementById('notification-dropdown');
          const notifTrigger = document.querySelector('[onclick*="toggleNotificationDropdown"]');
          const notifContainer = notifTrigger ? notifTrigger.parentElement : null;
          if (dropdown && notifContainer && !notifContainer.contains(e.target)) {
            dropdown.classList.remove('show');
          }
        });
      });
    </script>
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white">
    <nav class="fixed top-0 left-0 right-0 bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-900 dark:to-indigo-900 shadow-lg z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16 md:h-20">
          <!-- Logo/Title -->
          <div class="flex items-center gap-3">
            <img src="{{ url_for('static', filename='brand/logo-lockup.svg') }}" alt="FlowWorklist" class="h-10 md:h-12" style="max-width: 120px; height: auto;">
            <div class="hidden sm:block">
              <h1 class="text-white font-bold text-lg md:text-xl">FlowWorklist</h1>
              <p class="text-blue-100 text-xs">DICOM Worklist Server</p>
            </div>
          </div>
          <!-- Navigation Links -->
          <div class="hidden md:flex items-center gap-6">
            <a href="/" class="text-white hover:bg-blue-700 px-3 py-2 rounded-lg transition flex items-center gap-2" title="Home">
              <i class="fas fa-home"></i>
              <span data-i18n="home">Home</span>
            </a>
            <a href="/config" class="text-white hover:bg-blue-700 px-3 py-2 rounded-lg transition flex items-center gap-2">
              <i class="fas fa-cog"></i>
              <span data-i18n="config">Config</span>
            </a>
            <a href="/logs" class="text-white hover:bg-blue-700 px-3 py-2 rounded-lg transition flex items-center gap-2">
              <i class="fas fa-file-alt"></i>
              <span data-i18n="logs">Logs</span>
            </a>
            <a href="/tests" class="text-white hover:bg-blue-700 px-3 py-2 rounded-lg transition flex items-center gap-2">
              <i class="fas fa-flask"></i>
              <span data-i18n="tests">Tests</span>
            </a>
            <a href="/plugins" class="text-white hover:bg-blue-700 px-3 py-2 rounded-lg transition flex items-center gap-2">
              <i class="fas fa-plug"></i>
              <span data-i18n="plugins">Plugins</span>
            </a>
          </div>
          <!-- Right Controls -->
          <div class="flex items-center gap-4">
            <!-- Service Health Indicator + PID badge -->
            <div class="flex items-center gap-2">
              <span id="svc-health-dot" data-color="bg-red-500" class="w-3 h-3 rounded-full bg-red-500 ring-2 ring-transparent" title="Serviço"></span>
              <span id="svc-pid-badge" class="ml-1 px-1.5 py-0.5 text-[10px] rounded bg-white/20 text-white hidden"></span>
            </div>
            <!-- Notification Bell -->
            <div class="relative">
              <button onclick="toggleNotificationDropdown()" id="notification-bell" class="text-white hover:bg-blue-700 px-3 py-2 rounded-lg transition relative" data-i18n-title="title_notifications">
                <i class="fas fa-bell text-lg"></i>
                <span id="notification-badge" class="notification-badge hidden">0</span>
              </button>
              <div id="notification-dropdown" class="notification-dropdown bg-white dark:bg-gray-800">
                <div class="bg-blue-50 dark:bg-gray-700 px-4 py-3 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
                  <h3 class="font-bold text-gray-900 dark:text-white" data-i18n="notifications">Notificações</h3>
                  <button onclick="clearNotificationHistory()" class="text-xs text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300" data-i18n-title="title_clear_history">
                    <i class="fas fa-trash-alt"></i> <span data-i18n="clear">Limpar</span>
                  </button>
                </div>
                <div id="notification-history" class="divide-y divide-gray-200 dark:divide-gray-700 overflow-y-auto" style="max-height: 400px;"></div>
              </div>
            </div>
            <!-- Language Selector -->
            <div class="relative group">
              <button class="text-white hover:bg-blue-700 px-3 py-2 rounded-lg transition flex items-center gap-2" data-i18n-title="language">
                <i class="fas fa-globe"></i>
                <span id="langCode">PT</span>
              </button>
              <div class="absolute right-0 mt-0 w-40 bg-white dark:bg-gray-800 rounded-lg shadow-xl hidden group-hover:block py-2 z-50 max-h-80 overflow-y-auto">
                <button onclick="setLang('pt');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> Português</button>
                <button onclick="setLang('en');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> English</button>
                <button onclick="setLang('fr');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> Français</button>
                <button onclick="setLang('es');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> Español</button>
                <button onclick="setLang('zh');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> 中文</button>
                <button onclick="setLang('ru');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> Русский</button>
                <button onclick="setLang('ja');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> 日本語</button>
                <button onclick="setLang('it');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> Italiano</button>
                <button onclick="setLang('tr');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> Türkçe</button>
                <button onclick="setLang('fil');" class="block w-full text-left px-4 py-2 hover:bg-blue-100 dark:hover:bg-gray-700 text-gray-900 dark:text-white text-sm"> Filipino</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <main class="pt-24 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {% block content %}{% endblock %}
    </main>

    <script>
      // Atualizar status do card na home
      function refreshCardStatus() {
        if (document.location.pathname !== '/') return;
        fetch('/status')
          .then(r => r.json())
          .then(data => {
            const statusEl = document.getElementById('service-status');
            if (statusEl) {
              const running = !!(data.running || (data.service && data.service.running));
              const txt = running ? t('running') : t('stopped');
              const icon = running ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>';
              statusEl.innerHTML = `${icon} <span data-i18n="${running ? 'running' : 'stopped'}">${txt}</span>`;
              statusEl.className = running ? 'text-green-300' : 'text-red-300';
            }
          })
          .catch(() => {
            // Avoid unhandled errors when backend is down during homepage polling
          });
      }
      setInterval(refreshCardStatus, 1500);
      
      let lastStableClass = 'w-3 h-3 rounded-full bg-red-500';

      function setupNavLoading() {
        const navLinks = document.querySelectorAll('nav a[href]');
        navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
            if (link.target === '_blank') return;
            if (link.href === window.location.href) return;
            try {
              window._showLoadingBar = true;
              showLoadingBar();
            } catch (err) {}
          });
        });
      }

      async function refreshSvcDot() {
        // Skip status polling while user actions are in progress
        if (window._suppressStatusPoll || window._showLoadingBar) return;
        try {
          const dot = document.getElementById('svc-health-dot');
          const pidBadge = document.getElementById('svc-pid-badge');
          if (!dot) return;
          const statusRes = await fetch('/status', { cache: 'no-store' });
          const statusJson = await statusRes.json();
          const svc = statusJson.service || {};
          const svcRunning = !!(statusJson.running || svc.running);
          const pid = statusJson.pid || svc.pid;
          const runningTitle = t('service_hint_active');
          const stoppedTitle = t('service_hint_stopped');
          const unavailableTitle = t('service_hint_unavailable');
          let cls = 'w-3 h-3 rounded-full ';
          let title = '';
          if (svcRunning) {
            cls += 'bg-green-500';
            title = runningTitle;
            dot.dataset.color = 'bg-green-500';
          } else {
            cls += 'bg-red-500';
            title = stoppedTitle;
            dot.dataset.color = 'bg-red-500';
          }
          lastStableClass = cls;
          dot.className = cls + ' ring-2 ring-transparent';
          dot.title = title;
          dot.setAttribute('aria-label', title);
          setProcessingIndicator();

          if (pidBadge && pid) {
            pidBadge.textContent = `PID ${pid}`;
            pidBadge.classList.remove('hidden');
          } else if (pidBadge) {
            pidBadge.textContent = '';
            pidBadge.classList.add('hidden');
          }
          // Status dot refresh completed silently to avoid console noise
        } catch (e) {
          const dot = document.getElementById('svc-health-dot');
          const pidBadge = document.getElementById('svc-pid-badge');
          if (dot) {
            dot.className = `${lastStableClass} ring-2 ring-transparent`;
            dot.title = t('service_hint_unavailable');
            dot.dataset.color = lastStableClass.split(' ').find(c => c.startsWith('bg-')) || 'bg-red-500';
            setProcessingIndicator();
          }
          if (pidBadge) {
            pidBadge.textContent = '';
            pidBadge.classList.add('hidden');
          }
        }
      }

      // First paint ASAP after DOM ready, then poll
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          refreshSvcDot();
          setInterval(refreshSvcDot, 2000);
        });
      } else {
        refreshSvcDot();
        setInterval(refreshSvcDot, 2000);
      }
    </script>
  </body>
</html>
